const { pool } = require('../database/connection');
const { AppError, handleDatabaseError } = require('../utils/errorHandler');
const logger = require('../utils/logger');

// Get all products (optionally filter by category)
async function getAllProducts(categoryId) {
  try {
    let query = 'SELECT p.*, c.name as category_name FROM products p JOIN categories c ON p.category_id = c.id';
    const values = [];

    if (categoryId) {
      categoryId = parseInt(categoryId, 10);
      if (isNaN(categoryId) || categoryId < 1) {
        throw new AppError('Invalid category ID', 400, 'INVALID_CATEGORY_ID');
      }
      query += ' WHERE p.category_id = $1';
      values.push(categoryId);
    }

    query += ' ORDER BY p.created_at DESC LIMIT 1000';

    const result = await pool.query(query, values);
    logger.debug('ProductController', 'getAllProducts executed', {
      categoryId,
      rowCount: result.rowCount,
    });
    return result.rows;
  } catch (error) {
    if (error instanceof AppError) throw error;
    logger.error('ProductController', 'Error in getAllProducts', { error: error.message });
    throw handleDatabaseError(error, 'ProductController:getAllProducts');
  }
}

// Get single product by ID
async function getProductById(id) {
  try {
    id = parseInt(id, 10);
    if (isNaN(id) || id < 1) {
      throw new AppError('Invalid product ID', 400, 'INVALID_PRODUCT_ID');
    }

    const result = await pool.query(
      'SELECT p.*, c.name as category_name FROM products p JOIN categories c ON p.category_id = c.id WHERE p.id = $1',
      [id]
    );

    if (result.rows.length === 0) {
      return null;
    }

    return result.rows[0];
  } catch (error) {
    if (error instanceof AppError) throw error;
    logger.error('ProductController', 'Error in getProductById', { error: error.message, productId: id });
    throw handleDatabaseError(error, 'ProductController:getProductById');
  }
}

// Create new product
async function createProduct(name, description, price, categoryId, stock) {
  const client = await pool.connect();
  try {
    categoryId = parseInt(categoryId, 10);
    if (isNaN(categoryId) || categoryId < 1) {
      throw new AppError('Invalid category ID', 400, 'INVALID_CATEGORY_ID');
    }

    await client.query('BEGIN');

    // Check if category exists
    const categoryCheck = await client.query('SELECT id FROM categories WHERE id = $1', [categoryId]);
    if (categoryCheck.rows.length === 0) {
      await client.query('ROLLBACK');
      throw new AppError('Category not found', 404, 'CATEGORY_NOT_FOUND');
    }

    // Create product
    const result = await client.query(
      'INSERT INTO products (name, description, price, category_id, stock) VALUES ($1, $2, $3, $4, $5) RETURNING *',
      [name, description, price, categoryId, stock]
    );

    await client.query('COMMIT');
    logger.info('ProductController', 'Product created successfully', { productId: result.rows[0].id });
    return result.rows[0];
  } catch (error) {
    await client.query('ROLLBACK');
    if (error instanceof AppError) throw error;
    logger.error('ProductController', 'Error in createProduct', { error: error.message });
    throw handleDatabaseError(error, 'ProductController:createProduct');
  } finally {
    client.release();
  }
}

// Update product
async function updateProduct(id, name, description, price, stock) {
  try {
    id = parseInt(id, 10);
    if (isNaN(id) || id < 1) {
      throw new AppError('Invalid product ID', 400, 'INVALID_PRODUCT_ID');
    }

    // Build dynamic query based on provided fields
    const updates = [];
    const values = [];
    let paramCount = 1;

    if (name !== undefined) {
      updates.push(`name = $${paramCount}`);
      values.push(name);
      paramCount++;
    }

    if (description !== undefined) {
      updates.push(`description = $${paramCount}`);
      values.push(description);
      paramCount++;
    }

    if (price !== undefined) {
      updates.push(`price = $${paramCount}`);
      values.push(price);
      paramCount++;
    }

    if (stock !== undefined) {
      updates.push(`stock = $${paramCount}`);
      values.push(stock);
      paramCount++;
    }

    if (updates.length === 0) {
      throw new AppError('No fields to update', 400, 'NO_UPDATE_FIELDS');
    }

    values.push(id);
    const query = `UPDATE products SET ${updates.join(', ')}, updated_at = NOW() WHERE id = $${paramCount} RETURNING *`;

    const result = await pool.query(query, values);

    if (result.rows.length === 0) {
      return null;
    }

    logger.info('ProductController', 'Product updated successfully', { productId: id });
    return result.rows[0];
  } catch (error) {
    if (error instanceof AppError) throw error;
    logger.error('ProductController', 'Error in updateProduct', { error: error.message, productId: id });
    throw handleDatabaseError(error, 'ProductController:updateProduct');
  }
}

// Delete product
async function deleteProduct(id) {
  try {
    id = parseInt(id, 10);
    if (isNaN(id) || id < 1) {
      throw new AppError('Invalid product ID', 400, 'INVALID_PRODUCT_ID');
    }

    const result = await pool.query('DELETE FROM products WHERE id = $1 RETURNING *', [id]);

    if (result.rows.length === 0) {
      return null;
    }

    logger.info('ProductController', 'Product deleted successfully', { productId: id });
    return result.rows[0];
  } catch (error) {
    if (error instanceof AppError) throw error;
    logger.error('ProductController', 'Error in deleteProduct', { error: error.message, productId: id });
    throw handleDatabaseError(error, 'ProductController:deleteProduct');
  }
}

module.exports = {
  getAllProducts,
  getProductById,
  createProduct,
  updateProduct,
  deleteProduct,
};
